

# 開発ルール

このファイルは、本アプリケーション開発における永続的なルールと制約を記録します。AI開発者は、いかなる変更要求に対応する際も、まずこのファイルの内容を確認し、遵守する必要があります。

## 1. 変更の原則

- **【最重要】指示以外の変更は厳禁**: ユーザーから明確に指示された箇所以外のコードは、絶対に修正・削除・変更しないでください。リファクタリングや「良かれと思った」修正は、指示がない限り行わないでください。
- **機能の維持**: 既存の機能やロジックを、意図せず破壊したり、挙動を変えたりしないこと。変更は常に既存機能への影響を最小限に抑える形で行ってください。
- **一貫性の保持**: アプリケーション全体のデザイン、コンポーネント構造、状態管理（Context API, Reducer, Hooks）の一貫性を維持してください。

## 2. 開発プロセス

- **事前確認**: 変更に着手する前に、必ずこの`rules.md`と`changelog.md`を読み、過去の経緯とルールを把握してください。
- **メモリの更新**: 開発が完了したら、必ず以下のファイルを更新してください。
    - `changelog.md`: 行った変更内容を具体的かつ簡潔に追記します。
    - `rules.md`: ユーザーから新しいルールや制約が提示された場合に追記・更新します。
    - `tests.json`: 新機能の追加や重要な変更があった場合、動作確認用のテストケースを追記します。
- **バージョン表示の更新**: 開発完了後、`components/Header.tsx` 内の表示を、`changelog.md`の最新バージョン番号（例: `v1.20.0`）に更新してください。
- **バージョン運用ルール**: 小規模な変更やバグ修正は`+0.01`（例: v1.20.0 → v1.20.1）、大規模な機能追加や仕様変更は`+0.1`（例: v1.20.0 → v1.30.0）とします。

## 3. 品質ガイドライン

- **UI/UX**: すべてのUIは美しく、直感的に操作できる必要があります。ユーザー体験を最優先してください。
- **コード品質**: コードはクリーンで、読みやすく、メンテナンスしやすい状態を保ってください。

## 4. 個別機能ルール

- 東急ガスの契確要否：現時点では「契確あり」固定（UI非表示）。将来変更の可能性あり。
- 賃貸ねっと【無料施策】：既存回線UIを非表示（コメント非掲載の運用継続）。
- WTS：メールは共通`email`、任意。コメントは末尾に「メアド」を出力し、その後に「備考」を続ける。

- **プラチナでんき（契約確認なし）**: 全販路共通で、「プラチナでんき」で「契約確認なし」を選択した場合、「性別」は必須項目となります。
- **`ID:`レコードIDの名乗り自動入力**:
    - レコードIDが `ID:` で始まる場合に「名乗り」が「すまえる」に自動設定される機能は、**電気・ガスタブでのみ**有効です。
    - **インターネットタブでは自動設定されず、タブ切替時に自動設定の「すまえる」は引き継がれず空欄になります**。ただし同一 `recordId` では一度だけのクリアとし、**手入力は尊重**します。
    - サカイ販路選択時でもレコードIDは必須入力（非活性化禁止）。
    - **サカイ販路選択時は、レコードIDに英字が含まれていなくても警告モーダルを出さない（数字のみでも可）。**
- **ウォーターサーバーの機種と色**: サーバー機種によって選択可能な色が定義されています。新しい機種や色を追加・変更する際は、`constants.ts`内の`WTS_SERVERS`と`WTS_COLORS`の両方の定義を更新する必要があります。
- **ニチガス関連商材のガス立会時間枠**: 「ニチガス電気セット」および「ニチガス単品」のガス立会時間枠は、専用の4枠（9-12時, 13-15時, 15-17時, 17-19時）に固定されています。他のガス商材（すまいのガス、東邦ガス等）の時間枠はそれぞれ個別の定義を維持するため、変更はニチガス関連商材に限定してください。
- **コメント編集確認の再表示**: コメント欄の編集確認ダイアログは、一度「編集を続ける」を選択しても、レコードIDまたはタブが切り替わるとリセットされ、次回フォーカス時に再度表示されます。
- **主商材受注状況の表示条件**: 電気・ガスタブにおいて、「契約確認なし」が選択されている場合、「主商材受注状況」の入力フォームは非表示となり、必須入力項目からも除外されます。
- **契確時間の表示条件**: 全てのタブにおいて、「契確時間（elecConfirmationTime）」は「契約確認あり」が選択された場合にのみ表示・必須項目となります。
- **STJP:/S HAHZZTコード**: 「すまいのでんき」のSTJP:/S販路において、HAHZZTコード（HAHZZT293/HAHZZT276）は、「契約確認あり/なし」や「空室あり/なし」の選択状況に関わらず、**絶対に変更しません**。
- **`code:`表示と判定**: 自動判定販路の表示ラベルは`Code:`としますが、内部的な値（value）と判定ロジックは`'code:'`を維持します。レコードIDのプレフィックス判定は、`'code:'`と`'Code:'`を等価に扱う（大文字小文字を無視する）必要があります。
- **入力後確認モーダル**: 電話番号やフリガナの入力後チェックで表示されるモーダルのボタン文言と配色は、「修正する」を**深緑系（推奨）**、「しない」「続行」などの進行系ボタンを**赤系**で統一します（クリスマス配色）。
- **hasContractConfirmation（契約確認は必要ですか？）のラジオは常時選択可能（状態により disable しない）。**

- **ガス立会時間枠の統一仕様（2025-09-11）**
  - ガス単品：
    - すまいのガス／東邦ガス／東急ガス／大阪ガス：9-12 / 13-15 / 15-17
    - 東京ガス／ニチガス：9-12 / 13-15 / 15-17 / 17-19（※日祝は 17-19 選択不可・UIラベルで明示）
  - 電気（ガスセット）：
    - すまいのでんきのガスセット＝すまいのガスと同一枠
    - ニチガス電気セット＝ニチガスと同一枠
    - 東京ガス電気セット＝東京ガスと同一枠
    - 大阪ガス電気セット＝大阪ガスと同一枠
    - 東邦ガスセット＝東邦ガスと同一枠
  - 値（value）は `'9-12' | '13-15' | '15-17' | '17-19'` に固定。**キー名/型変更は禁止**。
  - 祝日自動判定は未導入。将来的に実装する場合も後方互換と最小差分を厳守。
  - **ストエネ関東・期間限定ルール（2025-11-21追記）**:
    - 対象：「すまいのガス単品」および「すまいのでんきガスセット」。
    - 条件：設置先住所が関東8都県（東京/神奈川/千葉/埼玉/茨城/栃木/群馬/山梨） かつ ガス開栓希望日が 2026/02/01〜2026/04/30。
    - 適用：ガス立会時間枠の選択肢を「9:00〜12:00」「PM 時間指定なし」の2パターンのみに限定。

- **ビルド/依存ルール（2025-09-11追加）**
- CDN経由のTailwindおよびBabel Standaloneの利用を禁止。TailwindはVite+PostCSSで処理する。
- React/アイコン類のURLインポート（esm.sh等）を禁止。npm依存＋lockfileで固定する。
- 上記は**挙動変更なし**を前提とし、import置換以外のコード改変は禁止。

- **ビルド環境差異への対応方針（2025-09-11追記）**
- AIスタジオ等でPostCSSパイプラインが無効な場合、TailwindはCDNを暫定使用可（version pin & index.html限定）。
- 本番でVite/PostCSSが有効な環境に移行する際はCDNを撤去し、同一見た目を確認してから切替える。

- **備考欄の扱い（2025-09-11）**
  - 備考はタブ別に独立：`elecRemarks` / `gasRemarks` / `internetRemarks` / `wtsRemarks`
  - 既存 `remarks` は後方互換のため残置（UIでは使用しない／削除禁止）
  - CB自動入力は電気タブ備考にのみ反映（条件・文言は従前どおり）
  - キー名・型の変更・削除は禁止。不要な差分を発生させないこと
  - みんな電力：インポート専用テンプレート。契約条件の「空室/ガスセット/主商材受注状況/契約確認/オール電化」は表示しない。営業コメントに含まれる基本項目（性別・メアドを含む）は必須。商材プルダウンでは最下段に配置する。

- 電気が「オール電化=あり」のときはガスセット提案不可（UIも出さない / isGasSetはクリア）。対象：すまいのでんき（UI非表示）、プラチナでんき（内部値クリアのみ）。

- 案内料金の初期値は product/housingType 変更時のみ再評価し、入力欄が空または直前の自動値と一致する場合に限り上書きする（ユーザー手入力は保持）。
- 賃貸ねっと【無料施策】は賃貸ねっとと同一ロジックの案内料金を用い、クロスパス無線ルーターは「プレゼント」単一選択。
- リミックスでんきは付帯=ありのときのみプラン行を「ベーシックプランセット」にする。
- 自動挿入の「5,000円CB」は商材切替等で条件外に変化した際、値がちょうど「5,000円CB」の場合のみ自動クリアする（任意編集された他文言は消さない）。
- 電気とガスの利用開始日は `moveInDate` / `gasOpeningDate` で独立管理する。

- **DOB入力（2025-09-16）**: 最終形式は `YYYY/MM/DD`。8桁・`-`・`.`・`M/D` は受理して自動正規化。不正はトーストで案内。
- **リミックスでんき（2025-09-16）**: 書面送付先は**常時選択必須**（新住所/現住所）。
- **ガス営業コメント（2025-09-16）**: `利用開始日` と `時間枠` は**横並び1行**で出力する。

- **日付入力規約**：入力は多様式受理（`YYYY/MM/DD` / `YYYY年MM月DD日` / `YYYYMMDD` / `YYYY[-./]MM[-./]DD` / `M/D`→当年補完）。内部保持は常に `YYYY/MM/DD`。妥当性判定は**`toISOString` を用いず**、**`getFullYear()/getMonth()/getDate()` の一致**で行う。
- すまいのでんき（ストエネ）：レコードIDが【ID:/No./それ以外】の案件は契確ラジオを常時表示。初期値は空欄。
- 上記で「契確＝なし」は **インポートのみ**。主商材受注状況は出さず、付帯OPは必須で「あり/なし」のいずれかを出力。
- 空室プラン時のヘッダは `HZEZZT011` を付与：`【ストエネ/★インポートのみ/※空室プラン/HZEZZT011】`。
- ヘッダ末尾には従来の管理タグ（例：250811）を付ける。
- SR／サカイ／S／STJP：／code: は本改修の対象外（現状維持）。
- **入力補正とバリデーション（2025-09-22）**
  - 入力値の自動補正は行わず、確認モーダルでユーザーに**促し**に留める（副作用回避）。
  - ベンダー/商材固有のバリデーション（例: SoftBankの名前スペース、東京ガスのフリガナ長）は、**対象の商材が選択されている条件下でのみ**発火させる。
- **東邦ガスセット（後確希望時間）**: 選択肢は **10-12 / 12-15 / 15-18 / 18-21**。
  ガス立会時間枠の定義（`TIME_SLOTS_TOHO_GAS_SETUP`）とは**別管理**とし、相互に影響しないこと。
- **東京ガス系名義9文字ブロック**: 「東京ガス電気セット」「東京ガス単品」では、契約者名義（漢字/フリガナ）がスペースを除き9文字以上の場合、続行不可のモーダルで修正を必須とする。
- **姓名スペース注意**: 全商材において、姓と名の間にスペースがない場合、続行可能なモーダルで注意を促す。
- **賃貸ねっとラック除外ルール**:
  - `賃貸ねっと × マンション`: ラック「無し」を除外。
  - `賃貸ねっと × 10G`: ラック「無し」は**必要**。
  - `賃貸ねっと【無料施策】`: ラック「無し」を除外。
- **郵便番号はハイフン有無を許容。**7桁以外は onBlur で確認モーダル**（修正/続行を選択）。**
- **インターネット商材の年齢条件/CP**:
  - **SB Air**: 25歳以下または60歳以上の場合、CP候補を専用の2択に絞り、案内料金を「2年3278円、3年以降5368円」で自動設定（未入力時のみ）。
  - **SB光10G**: CPを3種（6カ月/6カ月＋乗り換え/3カ月）に置き換え、CP選択に連動して案内料金を自動設定（未入力時のみ）。
- **警告（onBlur）**:
  - おうち割＝あり かつ 携帯キャリア≠SoftBank/Y!mobile の場合にモーダルで警告。
  - あんしん乗り換えCP選択 かつ 既存回線＝無し の場合にモーダルで警告。
  - 上記警告はコピーや保存を**ブロックしない**。
- **タブ遷移時の確認**: インターネット/WTSタブから電気/ガスタブへ遷移する際に、「顧客情報をリセットしますか？」の確認モーダルを表示。OKでリセット（AP名保持）＋遷移、キャンセルで情報保持＋遷移。
- **CP名称の管理**: CP名称は `constants.ts` を基準とし、表記変更は `constants.ts` 内の対象要素のみを置換する。
- **SB Air 案内料金の強制固定**: 「スマートライフ割」（および「＋あんしん乗り換え」）が選択されている間は、案内料金を「2年3278円、3年以降5368円」に常時強制上書きする。手入力は許可せず、初期表示時・選択時・編集後のフォーカスアウト時に常に上書き処理を実行する。
- **AUひかりの住所入力**: **AUひかりは `address` に『住所※物件名部屋番号まで全部』を入力する。`buildingInfo` 未入力チェックは適用しない。**
- **AUひかりの戸建て対応**: **AUひかりにも『戸建て』チェックを設け、オンで `address` 末尾に『戸建て』を付与/解除。**
- **既存ロジックの維持**: 上記のルール追加に伴い、既存の10G案内料金自動設定、U25/O60のCP候補分岐、各種警告モーダル（onBlur）の仕様は変更しない。
- **M/D 入力の年補完**：`moveInDate` と `gasOpeningDate` に限り、
  **同日は今年／過去は翌年** で `YYYY/MM/DD` に正規化。他日付には適用しない。
- **賃貸ねっと【無料施策】**：クロスパス無線ルーターは **『プレゼント』固定**（UIも値も）。
- ジライフウォーター（顧客タイプ）選択時のサーバー候補は、「amadana / スタンダードサーバー / fam2 / スリム4ロング / スリム4ショート」のみ。順序固定。スタンダードサーバーの色は「ホワイト / ブラック」。
- ジライフのヘッダは「【ジライフウォーター】 250811」。U20/法人の派生ヘッダは適用しない。
- 通常（プレミアムウォーター）の value は"通常"を維持する（互換性）。
- 賃貸ねっと【無料施策】では、タイプ未選択でもラック選択可能（マンション/マンション10Gの和集合）。ラックに「無し」は出さない。
- **タブ遷移時の住所統合**:
  - 電気/ガス → インターネット：`mailingBuildingInfo` を `currentAddress` に重複なく結合（`mailingOption` を問わない）。
  - 電気/ガス → WTS：`mailingOption` の値に関わらず、`mailingBuildingInfo` を `currentAddress` に重複なく結合。
- **住所系の数字は入力値を保持し、コピー時のみ半角正規化して出力する**（対象：address/currentAddress/buildingInfo/mailingBuildingInfo/wtsShippingAddress）。
- **住所の数字判定は半角/全角の 0–9 を対象とする**（漢数字は対象外）。
- **大阪ガス単品**：営業コメントの**電話番号・ガス事前連絡先・郵便番号はハイフン無し**で出力する。
- **郵便番号の体裁**：`hyphenProviders = ['東邦ガスセット','リミックスでんき','東急ガス','東邦ガス単品']` のみ `XXX-XXXX`。**その他は数字のみ**。
- **ウォーターサーバー（全商材）**：営業コメントでは電話番号・郵便番号をハイフン無しで出力する。
- **ニチガス（電気セット/単品）**：
  - `gasArea` は**固定リストからのプルダウン選択**とし、**その他は使用しない**。保存値は表示ラベルと同一の文字列。
  - 書面送付先は「現住所／新住所」選択可（2025-11-XX変更）。
  - 現住所選択時は `currentPostalCode`, `currentAddress`, `mailingBuildingInfo` を必須（コピー不可）。
  - 電話番号と郵便番号は営業コメントでハイフン無し出力（セット/単品共通）。
- `mailingOption==='現住所'` による現住所必須化は **リミックス／東邦ガスセット／東京ガス電気セット／ニチガス系のみ**対象。
- **フレッツ光トス（インターネット）**: フォーム仕様上、住所/物件名の入力欄は設けないため、コピー前ガードにおける「物件名＋部屋番号（buildingInfo）」の必須判定から除外する。既存の AUひかり / GMOドコモ光 と同等の扱いとする。
- ループでんき：営業コメントのヘッダに「/★インポートのみ」を含めない。他商材の同表記は現状維持。
- GMOドコモ光：後確希望（第1〜第3）の年未入力は、今日(Asia/Tokyo)基準で最も近い未来年を補完して `YYYY/MM/DD` で出力。
  - 許容フォーマット：`M/D`, `MM/DD`, `M月D日`（全角/半角、全角スラッシュ、空白混在を許容）
  - 年明示の入力は従来どおり。不正日付は原文返し。曜日付与なし。
### WTS 入居済みルール（2025-11-08追加）
- WTSタブに「入居済み」チェックを追加する。
- ON時は日付欄を非活性化し、営業コメントは「⑫入居予定日：入居済み」を出力。
- OFF時：従来どおり日付を出力。
- バリデーション：ON時は入居予定日の日付チェックをスキップ。
- 既存キー名/型の変更は禁止。新規キーは `wtsMoveInAlready:boolean` のみ。

### 東急でんきの運用
- 契約確認は必ず入る（UI非表示、内部値は「あり」固定）
- 主商材受注状況は必須
- ガスセット時：書面送付先は現住所固定、ガス開栓枠は東急ガスと同一
- 非ガスセット時：書面送付先は現住所/新住所の選択制（現住所選択時は現住所必須）

### すまいのガス（単品/ガスセット）の年末年始不可期間
- 対象：すまいのガス単品、および「すまいのでんき（ストエネ）」のガスセット
- 期間：2025/12/31〜2026/01/03（含む、地域差なし）
- 該当時はモーダル警告を出し、日付をクリアして再入力を促す