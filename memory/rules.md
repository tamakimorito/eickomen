# 開発ルール

このファイルは、本アプリケーション開発における永続的なルールと制約を記録します。AI開発者は、いかなる変更要求に対応する際も、まずこのファイルの内容を確認し、遵守する必要があります。

## 1. 変更の原則

- **【最重要】指示以外の変更は厳禁**: ユーザーから明確に指示された箇所以外のコードは、絶対に修正・削除・変更しないでください。リファクタリングや「良かれと思った」修正は、指示がない限り行わないでください。
- **機能の維持**: 既存の機能やロジックを、意図せず破壊したり、挙動を変えたりしないこと。変更は常に既存機能への影響を最小限に抑える形で行ってください。
- **一貫性の保持**: アプリケーション全体のデザイン、コンポーネント構造、状態管理（Context API, Reducer, Hooks）の一貫性を維持してください。

## 2. 開発プロセス

- **事前確認**: 変更に着手する前に、必ずこの`rules.md`と`changelog.md`を読み、過去の経緯とルールを把握してください。
- **メモリの更新**: 開発が完了したら、必ず以下のファイルを更新してください。
    - `changelog.md`: 行った変更内容を具体的かつ簡潔に追記します。
    - `rules.md`: ユーザーから新しいルールや制約が提示された場合に追記・更新します。
    - `tests.json`: 新機能の追加や重要な変更があった場合、動作確認用のテストケースを追記します。
- **バージョン表示の更新**: 開発完了後、`components/Header.tsx` 内の表示を、`changelog.md`の最新バージョン番号（例: `v1.20.0`）に更新してください。
- **バージョン運用ルール**: 小規模な変更やバグ修正は`+0.01`（例: v1.20.0 → v1.20.1）、大規模な機能追加や仕様変更は`+0.1`（例: v1.20.0 → v1.30.0）とします。

## 3. 品質ガイドライン

- **UI/UX**: すべてのUIは美しく、直感的に操作できる必要があります。ユーザー体験を最優先してください。
- **コード品質**: コードはクリーンで、読みやすく、メンテナンスしやすい状態を保ってください。

## 4. 個別機能ルール

- **プラチナでんき（契約確認なし）**: 全販路共通で、「プラチナでんき」で「契約確認なし」を選択した場合、「性別」は必須項目となります。
- **`ID:`レコードIDの名乗り自動入力**: 
    - レコードIDが `ID:` で始まる場合に「名乗り」が「すまえる」に自動設定される機能は、**電気・ガスタブでのみ**有効です。インターネットタブでは自動設定されません。
    - 電気・ガスタブで「すまえる」と自動設定された状態でインターネットタブに切り替えた場合、**名乗りは引き継がれず空欄になります。**
- **ウォーターサーバーの機種と色**: サーバー機種によって選択可能な色が定義されています。新しい機種や色を追加・変更する際は、`constants.ts`内の`WTS_SERVERS`と`WTS_COLORS`の両方の定義を更新する必要があります。
- **ニチガス関連商材のガス立会時間枠**: 「ニチガス電気セット」および「ニチガス単品」のガス立会時間枠は、専用の4枠（9-12時, 13-15時, 15-17時, 17-19時）に固定されています。他のガス商材（すまいのガス、東邦ガス等）の時間枠はそれぞれ個別の定義を維持するため、変更はニチガス関連商材に限定してください。
- **コメント編集確認の再表示**: コメント欄の編集確認ダイアログは、一度「編集を続ける」を選択しても、レコードIDまたはタブが切り替わるとリセットされ、次回フォーカス時に再度表示されます。
- **主商材受注状況の表示条件**: 電気・ガスタブにおいて、「契約確認なし」が選択されている場合、「主商材受注状況」の入力フォームは非表示となり、必須入力項目からも除外されます。
- **契確時間の表示条件**: 全てのタブにおいて、「契確時間（elecConfirmationTime）」は「契約確認あり」が選択された場合にのみ表示・必須項目となります。
- **STJP:/S HAHZZTコード**: 「すまいのでんき」のSTJP:/S販路において、HAHZZTコード（HAHZZT293/HAHZZT276）は、「契約確認あり/なし」や「空室あり/なし」の選択状況に関わらず、**絶対に変更しません**。
- **`code:`表示と判定**: 自動判定販路の表示ラベルは`Code:`としますが、内部的な値（value）と判定ロジックは`'code:'`を維持します。レコードIDのプレフィックス判定は、`'code:'`と`'Code:'`を等価に扱う（大文字小文字を無視する）必要があります。
- **入力後確認モーダル**: 電話番号やフリガナの入力後チェックで表示されるモーダルのボタン文言と配色は、「修正する」を青、「しない」をグレーで統一します。
- **hasContractConfirmation（契約確認は必要ですか？）のラジオは常時選択可能（状態により disable しない）。**

- **ガス立会時間枠の統一仕様（2025-09-11）**
  - ガス単品：
    - すまいのガス／東邦ガス／東急ガス／大阪ガス：9-12 / 13-15 / 15-17
    - 東京ガス／ニチガス：9-12 / 13-15 / 15-17 / 17-19（※日祝は 17-19 選択不可・UIラベルで明示）
  - 電気（ガスセット）：
    - すまいのでんきのガスセット＝すまいのガスと同一枠
    - ニチガス電気セット＝ニチガスと同一枠
    - 東京ガス電気セット＝東京ガスと同一枠
    - 大阪ガス電気セット＝大阪ガスと同一枠
    - 東邦ガスセット＝東邦ガスと同一枠
  - 値（value）は `'9-12' | '13-15' | '15-17' | '17-19'` に固定。**キー名/型変更は禁止**。
  - 祝日自動判定は未導入。将来的に実装する場合も後方互換と最小差分を厳守。

- **ビルド/依存ルール（2025-09-11追加）**
- CDN経由のTailwindおよびBabel Standaloneの利用を禁止。TailwindはVite+PostCSSで処理する。
- React/アイコン類のURLインポート（esm.sh等）を禁止。npm依存＋lockfileで固定する。
- 上記は**挙動変更なし**を前提とし、import置換以外のコード改変は禁止。

- **ビルド環境差異への対応方針（2025-09-11追記）**
- AIスタジオ等でPostCSSパイプラインが無効な場合、TailwindはCDNを暫定使用可（version pin & index.html限定）。
- 本番でVite/PostCSSが有効な環境に移行する際はCDNを撤去し、同一見た目を確認してから切替える。

- **備考欄の扱い（2025-09-11）**
  - 備考はタブ別に独立：`elecRemarks` / `gasRemarks` / `internetRemarks` / `wtsRemarks`
  - 既存 `remarks` は後方互換のため残置（UIでは使用しない／削除禁止）
  - CB自動入力は電気タブ備考にのみ反映（条件・文言は従前どおり）
  - キー名・型の変更・削除は禁止。不要な差分を発生させないこと

- 電気が「オール電化=あり」のときはガスセット提案不可（UIも出さない / isGasSetはクリア）。対象：すまいのでんき（UI非表示）、プラチナでんき（内部値クリアのみ）。

- 案内料金の初期値は product/housingType 変更時のみ再評価し、入力欄が空または直前の自動値と一致する場合に限り上書きする（ユーザー手入力は保持）。
- 賃貸ねっと【無料施策】は賃貸ねっとと同一ロジックの案内料金を用い、クロスパス無線ルーターは「プレゼント」単一選択。
- リミックスでんきは付帯=ありのときのみプラン行を「ベーシックプランセット」にする。
- 自動挿入の「5,000円CB」は商材切替等で条件外に変化した際、値がちょうど「5,000円CB」の場合のみ自動クリアする（任意編集された他文言は消さない）。
- 電気とガスの利用開始日は `moveInDate` / `gasOpeningDate` で独立管理する。

- **DOB入力（2025-09-16）**: 最終形式は `YYYY/MM/DD`。8桁・`-`・`.`・`M/D` は受理して自動正規化。不正はトーストで案内。
- **リミックスでんき（2025-09-16）**: 書面送付先は**常時選択必須**（新住所/現住所）。
- **ガス営業コメント（2025-09-16）**: `利用開始日` と `時間枠` は**横並び1行**で出力する。
- **ニチガス電気セット（2025-09-16）**: 書面送付先は**選択式**。現住所選択時は現住所情報を必須化。

- **日付入力規約**：入力は多様式受理（`YYYY/MM/DD` / `YYYY年MM月DD日` / `YYYYMMDD` / `YYYY[-./]MM[-./]DD` / `M/D`→当年補完）。内部保持は常に `YYYY/MM/DD`。妥当性判定は**`toISOString` を用いず**、**`getFullYear()/getMonth()/getDate()` の一致**で行う。
- すまいのでんき（ストエネ）：レコードIDが【ID:/No./それ以外】の案件は契確ラジオを常時表示。初期値は空欄。
- 上記で「契確＝なし」は **インポートのみ**。主商材受注状況は出さず、付帯OPは必須で「あり/なし」のいずれかを出力。
- 空室プラン時のヘッダは `HZEZZT011` を付与：`【ストエネ/★インポートのみ/※空室プラン/HZEZZT011】`。
- ヘッダ末尾には従来の管理タグ（例：250811）を付ける。
- SR／サカイ／S／STJP：／code: は本改修の対象外（現状維持）。
- **入力補正とバリデーション（2025-09-22）**
  - 入力値の自動補正は行わず、確認モーダルでユーザーに**促し**に留める（副作用回避）。
  - ベンダー/商材固有のバリデーション（例: SoftBankの名前スペース、東京ガスのフリガナ長）は、**対象の商材が選択されている条件下でのみ**発火させる。
- **東邦ガスセット（後確希望時間）**: 選択肢は **10-12 / 12-15 / 15-18 / 18-21**。
  ガス立会時間枠の定義（`TIME_SLOTS_TOHO_GAS_SETUP`）とは**別管理**とし、相互に影響しないこと。
- **東京ガス系名義9文字ブロック**: 「東京ガス電気セット」「東京ガス単品」では、契約者名義（漢字/フリガナ）がスペースを除き9文字以上の場合、続行不可のモーダルで修正を必須とする。
- **姓名スペース注意**: 全商材において、姓と名の間にスペースがない場合、続行可能なモーダルで注意を促す。
- **賃貸ねっとラック除外ルール**:
  - `賃貸ねっと × マンション`: ラック「無し」を除外。
  - `賃貸ねっと × 10G`: ラック「無し」は**必要**。
  - `賃貸ねっと【無料施策】`: ラック「無し」を除外。
